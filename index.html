<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BRS Toastmasters — Role Manager & Analytics (Dark)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --muted:#98a0b3; --accent:#4f9cff; --success:#1db954;
    --panel:#0c1521; --soft:#111827;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{margin:0;background:linear-gradient(180deg,#051022 0%, #071428 100%);color:#e6eef8;padding:20px;}
  header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
  .logo{height:64px;border-radius:8px}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .tabs{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);}
  .tab-buttons{display:flex;gap:8px;margin-bottom:12px}
  .tab-buttons button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbe9ff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tab-buttons button.active{background:linear-gradient(90deg,var(--accent),#6fb7ff);color:#021025;border-box:0}
  .view{display:none}
  .view.active{display:block}
  .panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .member-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  label.member{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
  input[type="text"], select{background:#071124;border:1px solid rgba(255,255,255,0.04);color:#dfefff;padding:8px;border-radius:8px;width:260px}
  button.btn{background:var(--accent);border:none;color:#021025;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dfefff;padding:8px 12px;border-radius:8px;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
  th{color:#cfe6ff;text-align:left}
  .final-row-odd{background:rgba(255,255,255,0.01)}
  .highlight{background:#0f3b24} /* cells >0 will use a greenish highlight */
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .flex-row{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .small{font-size:13px;padding:6px 8px;border-radius:6px}
  .muted-note{color:var(--muted);font-size:13px;margin-top:8px}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media(max-width:720px){.member-list{grid-template-columns:1fr} input[type="text"], select{width:100%}}
</style>
</head>
<body>
<header>
  <img src="https://lh3.googleusercontent.com/p/AF1QipPVYW9ttaOCrnoii0I5uPffN9PYeGM0KjOL21j5=s680-w680-h510-rw" alt="logo" class="logo">
  <div>
    <h1>BRS Toastmasters — Role Manager & Analytics</h1>
    <div class="muted">Dark mode • Connected to Google Sheets backend</div>
  </div>
</header>

<section class="tabs panel">
  <div class="tab-buttons">
    <button id="tabAssignBtn" class="active">Meeting Role Assignment</button>
    <button id="tabAnalyticsBtn">Member Analytics</button>
  </div>

  <!-- Assignment View -->
  <div id="assignView" class="view active">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label>Meeting Number: <input id="meetingNumber" type="text" placeholder="e.g. 2025-10-22-001"></label>
      <div class="right muted-note">Select attendees, then Assign → Confirm to save to Sheet</div>
    </div>

    <div style="margin-top:12px" class="panel">
      <div class="muted">Select attendees for the meeting:</div>
      <div class="member-list" id="memberList"></div>

      <div class="controls">
        <button class="btn" onclick="assignRoles()">Assign Roles Randomly</button>
        <button class="btn" onclick="confirmSelection()">Confirm & Save to Sheet</button>
        <button class="ghost" onclick="newMeeting()">New Meeting</button>
        <button class="ghost" onclick="resetHistory()">Reset Local History</button>
      </div>

      <div id="rolesSection" style="margin-top:12px">
        <h3>Role Assignments (editable)</h3>
        <table id="rolesTable"><tr><th>Role</th><th>Assigned To</th></tr></table>
      </div>

      <div id="finalizeNotice" class="muted-note"></div>
    </div>

    <div style="margin-top:16px">
      <h3>Saved Meetings (local)</h3>
      <div id="finalMeetings"></div>
    </div>
  </div>

  <!-- Analytics View -->
  <div id="analyticsView" class="view">
    <div class="panel">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <label>Member Filter:
          <select id="memberFilter"></select>
        </label>

        <label>Chart Type:
          <select id="chartType">
            <option value="bar">Horizontal Bar (roles on Y)</option>
            <option value="pie">Pie Chart (role distribution)</option>
          </select>
        </label>

        <div class="right">
          <button class="btn" onclick="refreshAnalytics()">Refresh Analytics</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4>Summary Table</h4>
        <div id="summaryTableWrap"></div>
      </div>

      <div style="margin-top:12px">
        <h4>Chart</h4>
        <canvas id="analyticsChart" style="max-width:100%;height:420px"></canvas>
      </div>
    </div>
  </div>
</section>

<footer class="muted-note">Note: The page posts confirmed roles to your Google Apps Script; ensure the script is deployed as Web App with access set to Anyone.</footer>

<script>
/* --------- Configuration --------- */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyWd1wDiXD3-_PXkIfGHGZ_kvj0uFE94cusEei3CafoROHwaPYhtbTiKeGvP24WtBcx/exec';

/* Members and roles */
const members = [
  "TM Anupama","TM Nisha","TM Shafeek","TM Asiya","TM Ramya",
  "TM Abhilash","TM Yamini","TM Ali","TM Kamlesh","TM Tushar",
  "TM Rahula","TM Sanal"
];

const fixedRoles = {
  "Sergant at Arms": "TM Anupama",
  "Club President": "TM Nisha"
};

const rotatingRoles = [
  "ToastMaster of the Day",
  "Word Master",
  "Aah Counter",
  "Speech",
  "Timer",
  "Table Topic Master",
  "Speech Evaluator"
];

const allTrackedRoles = rotatingRoles.slice(); // for analytics

/* --------- UI init --------- */
const memberListDiv = document.getElementById('memberList');
members.forEach(m => {
  const label = document.createElement('label');
  label.className = 'member';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.value=m;
  label.appendChild(cb);
  label.appendChild(document.createTextNode(' ' + m));
  memberListDiv.appendChild(label);
});

/* Tabs */
const tabAssignBtn = document.getElementById('tabAssignBtn');
const tabAnalyticsBtn = document.getElementById('tabAnalyticsBtn');
const assignView = document.getElementById('assignView');
const analyticsView = document.getElementById('analyticsView');

tabAssignBtn.onclick = () => { tabAssignBtn.classList.add('active'); tabAnalyticsBtn.classList.remove('active'); assignView.classList.add('active'); analyticsView.classList.remove('active'); };
tabAnalyticsBtn.onclick = () => { tabAnalyticsBtn.classList.add('active'); tabAssignBtn.classList.remove('active'); analyticsView.classList.add('active'); assignView.classList.remove('active'); refreshAnalytics(); };

/* Local storage */
let roleHistory = JSON.parse(localStorage.getItem('roleHistory')) || {};
let finalizedMeetings = JSON.parse(localStorage.getItem('finalizedMeetings')) || {};
renderFinalMeetings();

/* --------- Assignment logic --------- */
function assignRoles(){
  const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
  if(checked.length < rotatingRoles.length){ alert('Not enough attendees to fill all roles!'); return; }
  let available = [...checked];
  let assignments = {...fixedRoles};
  rotatingRoles.forEach(role => {
    let filtered = available.filter(m => roleHistory[role] !== m);
    if(filtered.length === 0) filtered = available;
    const idx = Math.floor(Math.random()*filtered.length);
    const selected = filtered[idx];
    assignments[role] = selected;
    available = available.filter(m => m !== selected);
    roleHistory[role] = selected;
  });
  localStorage.setItem('roleHistory', JSON.stringify(roleHistory));
  renderTable(assignments, checked);
}

function renderTable(assignments, attendees){
  document.getElementById('rolesSection').style.display = 'block';
  const table = document.getElementById('rolesTable');
  table.innerHTML = '<tr><th>Role</th><th>Assigned To</th></tr>';
  for(let role in assignments){
    const row = document.createElement('tr');
    const select = document.createElement('select');
    attendees.forEach(a => { const opt=document.createElement('option'); opt.value=a; opt.text=a; if(a===assignments[role]) opt.selected=true; select.appendChild(opt); });
    row.innerHTML = `<td>${role}</td>`;
    const cell = document.createElement('td'); cell.appendChild(select); row.appendChild(cell); table.appendChild(row);
  }
}

/* Confirm selection: save locally and POST to Google Sheet */
function confirmSelection(){
  const meetingNumber = document.getElementById('meetingNumber').value.trim();
  if(!meetingNumber){ alert('Please enter a meeting number.'); return; }
  const rows = document.querySelectorAll('#rolesTable tr');
  let assignments = {};
  rows.forEach((row,i)=>{ if(i===0) return; const role=row.cells[0].innerText; const selected=row.cells[1].querySelector('select').value; assignments[role]=selected; });
  finalizedMeetings[meetingNumber] = assignments; localStorage.setItem('finalizedMeetings', JSON.stringify(finalizedMeetings));
  renderFinalMeetings();

  // POST each role as a row to Google Sheets (Apps Script)
  if(WEB_APP_URL && WEB_APP_URL!=='WEB_APP_URL'){
    Object.keys(assignments).forEach(role => {
      const payload = { meetingNumber, role, member: assignments[role] };
      fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
      .then(r=>r.json()).then(()=>{}).catch(e=>console.warn('Sheet POST failed',e));
    });
  } else {
    console.warn('WEB_APP_URL not configured');
  }

  // hide assignment area after confirming
  document.getElementById('rolesSection').style.display = 'none';
  document.getElementById('finalizeNotice').innerText = 'Assignments saved locally and sent to Google Sheets (if configured).';
}

/* New meeting */
function newMeeting(){
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  document.getElementById('meetingNumber').value='';
  document.getElementById('rolesSection').style.display='block';
  document.getElementById('rolesTable').innerHTML = '<tr><th>Role</th><th>Assigned To</th></tr>';
  document.getElementById('finalizeNotice').innerText = '';
}

/* Reset history */
function resetHistory(){ localStorage.removeItem('roleHistory'); roleHistory={}; alert('Local role history reset.'); }

/* Final meetings rendering */
function renderFinalMeetings(){ const container=document.getElementById('finalMeetings'); container.innerHTML=''; for(let meeting in finalizedMeetings){ const section=document.createElement('div'); section.className='panel'; section.style.marginBottom='10px'; let html=`<div style="display:flex;align-items:center;justify-content:space-between"><strong>Meeting ${meeting}</strong><div><button class="ghost" onclick="deleteMeeting('${meeting}')">Delete</button></div></div>`; html += '<table><tr><th>Role</th><th>Assigned To</th></tr>'; let i=0; for(let role in finalizedMeetings[meeting]){ const cls = (i%2===0)? 'final-row-even':'final-row-odd'; html += `<tr class="${cls}"><td>${role}</td><td>${finalizedMeetings[meeting][role]}</td></tr>`; i++; } html += '</table>'; section.innerHTML = html; container.appendChild(section);} }

function deleteMeeting(meeting){ delete finalizedMeetings[meeting]; localStorage.setItem('finalizedMeetings', JSON.stringify(finalizedMeetings)); renderFinalMeetings(); }

/* --------- Analytics --------- */
// Member filter: only single-member selection allowed (no 'ALL')
const memberFilter = document.getElementById('memberFilter');
members.forEach(m => { const opt = new Option(m,m); memberFilter.appendChild(opt); });
// ensure a default selected member
if(memberFilter.options.length) memberFilter.selectedIndex = 0;

let chartInstance = null;

async function fetchSheetData(){
  try{
    const res = await fetch(WEB_APP_URL);
    const rows = await res.json();
    return rows;
  }catch(err){
    console.warn('Failed to fetch sheet data',err);
    alert('Failed to fetch sheet data. Check Apps Script deployment and access.');
    return null;
  }
}

function buildSummaryTable(counts){
  const wrap = document.getElementById('summaryTableWrap'); wrap.innerHTML='';
  const table = document.createElement('table');
  const header = document.createElement('tr');
  header.innerHTML = '<th>Member</th>' + allTrackedRoles.map(r=>`<th>${r}</th>`).join('');
  table.appendChild(header);
  members.forEach(m => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${m}</td>` + allTrackedRoles.map(r=>`<td ${ (counts[m] && counts[m][r]) ? 'class="highlight"' : '' }>${counts[m] && counts[m][r] ? counts[m][r] : 0}</td>`).join('');
    table.appendChild(row);
  });
  wrap.appendChild(table);
}

function normalizeRows(rows){
  // Accept rows with headers or keys: Meeting Number|Role|Member|Date  OR keys meetingNumber/role/member
  return rows.map(r => ({ meeting: r['Meeting Number']||r.meetingNumber||r.meeting||'', role: r['Role']||r.role||r.Role||'', member: r['Member']||r.member||'' }));
}

async function refreshAnalytics(){
  const rows = await fetchSheetData(); if(!rows) return;
  const normalized = normalizeRows(rows);
  // build counts per member per role
  const counts = {};
  normalized.forEach(rec => {
    if(!rec.member || !rec.role) return;
    const m = rec.member; const role = rec.role;
    if(!counts[m]) counts[m] = {};
    if(!counts[m][role]) counts[m][role] = 0;
    counts[m][role]++;
  });
  buildSummaryTable(counts);

  // Chart behavior: MemberFilter has only one member selection -> show that member's distribution across roles
  const selectedMember = memberFilter.value;
  const chartType = document.getElementById('chartType').value;

  // prepare data for selected member
  const dataForMember = allTrackedRoles.map(r => counts[selectedMember] && counts[selectedMember][r] ? counts[selectedMember][r] : 0);

  // destroy previous chart
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('analyticsChart').getContext('2d');

  if(chartType === 'bar'){
    // horizontal bar: roles on Y, counts on X for the selected member
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: allTrackedRoles,
        datasets: [{ label: selectedMember, data: dataForMember, backgroundColor: 'rgba(79,156,255,0.85)' }]
      },
      options: {
        indexAxis: 'y', // horizontal bars (roles on Y)
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Count' } },
          y: { title: { display: true, text: 'Roles' } }
        },
        plugins: { legend: { display: true } }
      }
    });
  } else {
    // pie chart: distribution of roles for selected member
    chartInstance = new Chart(ctx, {
      type: 'pie',
      data: { labels: allTrackedRoles, datasets: [{ data: dataForMember, backgroundColor: allTrackedRoles.map((_,i)=>`hsl(${i*45 % 360} 70% 60%)`) }] },
      options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });
  }
}

/* Ensure pie chart updates when changing chart type or member filter */
document.getElementById('chartType').addEventListener('change', refreshAnalytics);
memberFilter.addEventListener('change', refreshAnalytics);

/* initial analytics load when switching tab */
// handled by tab switch listener earlier which calls refreshAnalytics

</script>
</body>
</html>
