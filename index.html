<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BRS Toastmasters — Role Manager & Analytics (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --accent:#4f9cff;
    --success:#1db954;
  }
  /* Light theme variables */
  :root.light{
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #0b1220;
    --muted: #556070;
    --border: rgba(11,18,32,0.06);
    --highlight: #e6f4ff;
    --cell-high: #e6fff0;
  }
  /* Dark theme variables (default) */
  :root.dark{
    --bg:#071428;
    --card:#0f1724;
    --text:#e6eef8;
    --muted:#98a0b3;
    --border: rgba(255,255,255,0.03);
    --highlight: rgba(255,255,255,0.02);
    --cell-high: #0f3b24;
  }

  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{margin:0;background:var(--bg);color:var(--text);padding:18px;}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{height:64px;border-radius:8px}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .theme-toggle{margin-left:auto;display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:999px;background:transparent;border:1px solid var(--border);cursor:pointer}
  .tabs{background:var(--card);padding:16px;border-radius:12px;border:1px solid var(--border);}
  .tab-buttons{display:flex;gap:8px;margin-bottom:12px}
  .tab-buttons button{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .tab-buttons button.active{background:linear-gradient(90deg,var(--accent),#6fb7ff);color:#021025;border-box:0}
  .view{display:none}
  .view.active{display:block}
  .panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid var(--border)}
  .member-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  label.member{display:flex;align-items:center;gap:8px;background:var(--highlight);padding:8px;border-radius:8px;border:1px solid var(--border);color:var(--text)}
  input[type="text"], select{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;width:260px}
  button.btn{background:var(--accent);border:none;color:#021025;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:transparent}
  th,td{padding:8px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text)}
  th{font-weight:600}
  .final-row-odd{background:transparent}
  .highlight-cell{background:var(--cell-high);color:var(--text);font-weight:600}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .flex-row{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .small{font-size:13px;padding:6px 8px;border-radius:6px}
  .muted-note{color:var(--muted);font-size:13px;margin-top:8px}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media(max-width:720px){.member-list{grid-template-columns:1fr} input[type="text"], select{width:100%}}

  /* compact chart sizing */
  .chart-wrap{max-width:900px;margin-top:12px}
  canvas{display:block;max-width:100%;height:280px !important}
</style>
</head>
<body>
<header>
  <img src="https://lh3.googleusercontent.com/p/AF1QipPVYW9ttaOCrnoii0I5uPffN9PYeGM0KjOL21j5=s680-w680-h510-rw" alt="logo" class="logo">
  <div>
    <h1>BRS Toastmasters — Role Manager & Analytics</h1>
    <div class="muted">Theme toggle • Compact charts • Google Sheets backend</div>
  </div>
  <button id="themeToggle" class="theme-toggle" title="Toggle theme">🌙</button>
</header>

<section class="tabs panel">
  <div class="tab-buttons">
    <button id="tabAssignBtn" class="active">Meeting Role Assignment</button>
    <button id="tabAnalyticsBtn">Member Analytics</button>
  </div>

  <!-- Assignment View -->
  <div id="assignView" class="view active">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label>Meeting Number: <input id="meetingNumber" type="text" placeholder="e.g. 2025-10-22-001"></label>
      <div class="right muted-note">Select attendees, then Assign → Confirm to save to Sheet</div>
    </div>

    <div style="margin-top:12px" class="panel">
      <div class="muted">Select attendees for the meeting:</div>
      <div class="member-list" id="memberList"></div>

      <div class="controls">
        <button class="btn" onclick="assignRoles()">Assign Roles Randomly</button>
        <button class="btn" onclick="confirmSelection()">Confirm & Save to Sheet</button>
        <button class="ghost" onclick="newMeeting()">New Meeting</button>
        <button class="ghost" onclick="resetHistory()">Reset Local History</button>
      </div>

      <div id="rolesSection" style="margin-top:12px">
        <h3>Role Assignments (editable)</h3>
        <table id="rolesTable"><tr><th>Role</th><th>Assigned To</th></tr></table>
      </div>

      <div id="finalizeNotice" class="muted-note"></div>
    </div>

    <div style="margin-top:16px">
      <h3>Saved Meetings (local)</h3>
      <div id="finalMeetings"></div>
    </div>
  </div>

  <!-- Analytics View -->
  <div id="analyticsView" class="view">
    <div class="panel">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <label>Member Filter:
          <select id="memberFilter">
            <option value="ALL">All Members</option>
          </select>
        </label>

        <label>Chart Type:
          <select id="chartType">
            <option value="bar">Horizontal Bar (roles on Y)</option>
            <option value="pie">Pie Chart (role distribution)</option>
          </select>
        </label>

        <div class="right">
          <button class="btn" onclick="refreshAnalytics()">Refresh Analytics</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4>Summary Table</h4>
        <div id="summaryTableWrap"></div>
      </div>

      <div style="margin-top:12px" class="chart-wrap">
        <h4>Chart</h4>
        <canvas id="analyticsChart"></canvas>
      </div>
    </div>
  </div>
</section>

<footer class="muted-note">Note: The page posts confirmed roles to your Google Apps Script; ensure the script is deployed as Web App with access set to Anyone.</footer>

<script>
/* --------- Configuration --------- */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyWd1wDiXD3-_PXkIfGHGZ_kvj0uFE94cusEei3CafoROHwaPYhtbTiKeGvP24WtBcx/exec';

/* Members and roles */
const members = [
  "TM Anupama","TM Nisha","TM Shafeek","TM Asiya","TM Ramya",
  "TM Abhilash","TM Yamini","TM Ali","TM Kamlesh","TM Tushar",
  "TM Rahula","TM Sanal"
];

const fixedRoles = {
  "Sergant at Arms": "TM Anupama",
  "Club President": "TM Nisha"
};

const rotatingRoles = [
  "ToastMaster of the Day",
  "Word Master",
  "Aah Counter",
  "Speech",
  "Timer",
  "Table Topic Master",
  "Speech Evaluator"
];

const allTrackedRoles = rotatingRoles.slice(); // for analytics

/* --------- Theme handling --------- */
const root = document.documentElement;
const themeToggle = document.getElementById('themeToggle');
function applyTheme(t){
  if(t === 'light'){ root.classList.remove('dark'); root.classList.add('light'); themeToggle.textContent = '☀️'; }
  else { root.classList.remove('light'); root.classList.add('dark'); themeToggle.textContent = '🌙'; }
  localStorage.setItem('theme', t);
}
// default dark unless saved
const savedTheme = localStorage.getItem('theme') || 'dark';
applyTheme(savedTheme);
themeToggle.addEventListener('click', ()=>{ const cur = root.classList.contains('dark') ? 'dark':'light'; applyTheme(cur==='dark' ? 'light' : 'dark'); });

/* --------- UI init --------- */
const memberListDiv = document.getElementById('memberList');
members.forEach(m => {
  const label = document.createElement('label');
  label.className = 'member';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.value=m;
  label.appendChild(cb);
  label.appendChild(document.createTextNode(' ' + m));
  memberListDiv.appendChild(label);
});

/* Tabs */
const tabAssignBtn = document.getElementById('tabAssignBtn');
const tabAnalyticsBtn = document.getElementById('tabAnalyticsBtn');
const assignView = document.getElementById('assignView');
const analyticsView = document.getElementById('analyticsView');

tabAssignBtn.onclick = () => { tabAssignBtn.classList.add('active'); tabAnalyticsBtn.classList.remove('active'); assignView.classList.add('active'); analyticsView.classList.remove('active'); };
tabAnalyticsBtn.onclick = () => { tabAnalyticsBtn.classList.add('active'); tabAssignBtn.classList.remove('active'); analyticsView.classList.add('active'); assignView.classList.remove('active'); refreshAnalytics(); };

/* Local storage */
let roleHistory = JSON.parse(localStorage.getItem('roleHistory')) || {};
let finalizedMeetings = JSON.parse(localStorage.getItem('finalizedMeetings')) || {};
renderFinalMeetings();

/* --------- Assignment logic --------- */
function assignRoles(){
  const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
  if(checked.length < rotatingRoles.length){ alert('Not enough attendees to fill all roles!'); return; }
  let available = [...checked];
  let assignments = {...fixedRoles};
  rotatingRoles.forEach(role => {
    let filtered = available.filter(m => roleHistory[role] !== m);
    if(filtered.length === 0) filtered = available;
    const idx = Math.floor(Math.random()*filtered.length);
    const selected = filtered[idx];
    assignments[role] = selected;
    available = available.filter(m => m !== selected);
    roleHistory[role] = selected;
  });
  localStorage.setItem('roleHistory', JSON.stringify(roleHistory));
  renderTable(assignments, checked);
}

function renderTable(assignments, attendees){
  document.getElementById('rolesSection').style.display = 'block';
  const table = document.getElementById('rolesTable');
  table.innerHTML = '<tr><th>Role</th><th>Assigned To</th></tr>';
  for(let role in assignments){
    const row = document.createElement('tr');
    const select = document.createElement('select');
    attendees.forEach(a => { const opt=document.createElement('option'); opt.value=a; opt.text=a; if(a===assignments[role]) opt.selected=true; select.appendChild(opt); });
    row.innerHTML = `<td>${role}</td>`;
    const cell = document.createElement('td'); cell.appendChild(select); row.appendChild(cell); table.appendChild(row);
  }
}

/* Confirm selection: save locally and POST to Google Sheet */
function confirmSelection(){
  const meetingNumber = document.getElementById('meetingNumber').value.trim();
  if(!meetingNumber){ alert('Please enter a meeting number.'); return; }
  const rows = document.querySelectorAll('#rolesTable tr');
  let assignments = {};
  rows.forEach((row,i)=>{ if(i===0) return; const role=row.cells[0].innerText; const selected=row.cells[1].querySelector('select').value; assignments[role]=selected; });
  finalizedMeetings[meetingNumber] = assignments; localStorage.setItem('finalizedMeetings', JSON.stringify(finalizedMeetings));
  renderFinalMeetings();

  // POST each role as a row to Google Sheets (Apps Script)
  if(WEB_APP_URL && WEB_APP_URL!=='WEB_APP_URL'){
    Object.keys(assignments).forEach(role => {
      const payload = { meetingNumber, role, member: assignments[role] };
      fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
      .then(r=>r.json()).then(()=>{}).catch(e=>console.warn('Sheet POST failed',e));
    });
  } else {
    console.warn('WEB_APP_URL not configured');
  }

  // hide assignment area after confirming
  document.getElementById('rolesSection').style.display = 'none';
  document.getElementById('finalizeNotice').innerText = 'Assignments saved locally and sent to Google Sheets (if configured).';
}

/* New meeting */
function newMeeting(){
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  document.getElementById('meetingNumber').value='';
  document.getElementById('rolesSection').style.display='block';
  document.getElementById('rolesTable').innerHTML = '<tr><th>Role</th><th>Assigned To</th></tr>';
  document.getElementById('finalizeNotice').innerText = '';
}

/* Reset history */
function resetHistory(){ localStorage.removeItem('roleHistory'); roleHistory={}; alert('Local role history reset.'); }

/* Final meetings rendering */
function renderFinalMeetings(){ const container=document.getElementById('finalMeetings'); container.innerHTML=''; for(let meeting in finalizedMeetings){ const section=document.createElement('div'); section.className='panel'; section.style.marginBottom='10px'; let html=`<div style="display:flex;align-items:center;justify-content:space-between"><strong>Meeting ${meeting}</strong><div><button class="ghost" onclick="deleteMeeting('${meeting}')">Delete</button></div></div>`; html += '<table><tr><th>Role</th><th>Assigned To</th></tr>'; let i=0; for(let role in finalizedMeetings[meeting]){ const cls = (i%2===0)? 'final-row-even':'final-row-odd'; html += `<tr class="${cls}"><td>${role}</td><td>${finalizedMeetings[meeting][role]}</td></tr>`; i++; } html += '</table>'; section.innerHTML = html; container.appendChild(section);} }

function deleteMeeting(meeting){ delete finalizedMeetings[meeting]; localStorage.setItem('finalizedMeetings', JSON.stringify(finalizedMeetings)); renderFinalMeetings(); }

/* --------- Analytics --------- */
const memberFilter = document.getElementById('memberFilter');
// populate filter with All + members
memberFilter.innerHTML = '';
memberFilter.appendChild(new Option('All Members','ALL'));
members.forEach(m => { const opt = new Option(m,m); memberFilter.appendChild(opt); });
// default to ALL
memberFilter.value = 'ALL';

let chartInstance = null;

async function fetchSheetData(){
  try{
    const res = await fetch(WEB_APP_URL);
    const rows = await res.json();
    return rows;
  }catch(err){
    console.warn('Failed to fetch sheet data',err);
    alert('Failed to fetch sheet data. Check Apps Script deployment and access.');
    return null;
  }
}

function buildSummaryTable(counts){
  const wrap = document.getElementById('summaryTableWrap'); wrap.innerHTML='';
  const table = document.createElement('table');
  const header = document.createElement('tr');
  header.innerHTML = '<th>Member</th>' + allTrackedRoles.map(r=>`<th>${r}</th>`).join('');
  table.appendChild(header);
  members.forEach(m => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${m}</td>` + allTrackedRoles.map(r=>{
      const val = counts[m] && counts[m][r] ? counts[m][r] : 0;
      return `<td ${ val>0 ? 'class="highlight-cell"' : '' }>${val}</td>`;
    }).join('');
    table.appendChild(row);
  });
  wrap.appendChild(table);
}

function normalizeRows(rows){
  return rows.map(r => ({ meeting: r['Meeting Number']||r.meetingNumber||r.meeting||'', role: r['Role']||r.role||r.Role||'', member: r['Member']||r.member||'' }));
}

async function refreshAnalytics(){
  const rows = await fetchSheetData(); if(!rows) return;
  const normalized = normalizeRows(rows);
  // build counts per member per role
  const counts = {};
  normalized.forEach(rec => {
    if(!rec.member || !rec.role) return;
    const m = rec.member; const role = rec.role;
    if(!counts[m]) counts[m] = {};
    if(!counts[m][role]) counts[m][role] = 0;
    counts[m][role]++;
  });
  buildSummaryTable(counts);

  const selected = document.getElementById('memberFilter').value;
  const chartType = document.getElementById('chartType').value;

  // prepare data depending on selection
  let labels = [];
  let dataVals = [];
  if(selected === 'ALL'){
    // aggregate totals per role across all members
    labels = allTrackedRoles;
    dataVals = labels.map(role => {
      let sum = 0;
      for(const m in counts){ if(counts[m] && counts[m][role]) sum += counts[m][role]; }
      return sum;
    });
  } else {
    labels = allTrackedRoles;
    dataVals = labels.map(role => counts[selected] && counts[selected][role] ? counts[selected][role] : 0);
  }

  // destroy previous chart
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('analyticsChart').getContext('2d');

  if(chartType === 'bar'){
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: selected === 'ALL' ? 'All Members (role totals)' : selected, data: dataVals, backgroundColor: 'rgba(79,156,255,0.85)' }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { title: { display: true, text: 'Count' } }, y: { title: { display: true, text: 'Roles' } } },
        plugins: { legend: { display: true } }
      }
    });
  } else {
    chartInstance = new Chart(ctx, {
      type: 'pie',
      data: { labels: labels, datasets: [{ data: dataVals, backgroundColor: labels.map((_,i)=>`hsl(${i*45 % 360} 70% 60%)`) }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
  }
}

/* Ensure charts update when filter/type changes */
document.getElementById('chartType').addEventListener('change', refreshAnalytics);
document.getElementById('memberFilter').addEventListener('change', refreshAnalytics);

/* initial analytics load handled when tab clicked */

/* load */
</script>
</body>
</html>
